name: Dispatch Version to Child Repos

on:
  workflow_dispatch:       # allows manual testing
  release:
    types: [published]    # still triggers on real releases

permissions:
  contents: read

jobs:
  send_version:
    runs-on: ubuntu-latest
    environment: dispatch   # <- your environment name, injects secrets

    steps:
      # Step 1: Set version for manual testing
      - name: Set version for workflow_dispatch
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "VERSION=4.7.1" >> $GITHUB_ENV

      # Step 2: Extract version from release tag
      - name: Extract version from release
        if: ${{ github.event_name == 'release' }}
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      # Step 3: Dispatch to Craft-Froala-WYSIWYG-A
      - name: Dispatch to Craft-Froala-WYSIWYG-A
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token $dispatch" \
            https://api.github.com/repos/rajani0406/Craft-Froala-WYSIWYG-A/dispatches \
            -d '{"event_type":"sync-version", "client_payload": {"version":"'"${VERSION}"'"}}')
          echo "HTTP status: $RESPONSE"
          if [ "$RESPONSE" -eq 204 ]; then
            echo "✅ Dispatch PAT works for Craft-Froala-WYSIWYG-A"
          else
            echo "❌ Dispatch PAT failed for Craft-Froala-WYSIWYG-A"
            exit 1
          fi

      # Step 4: Dispatch to yii2-froala-editor-B
      - name: Dispatch to yii2-froala-editor-B
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token $dispatch" \
            https://api.github.com/repos/rajani0406/yii2-froala-editor-B/dispatches \
            -d '{"event_type":"sync-version", "client_payload": {"version":"'"${VERSION}"'"}}')
          echo "HTTP status: $RESPONSE"
          if [ "$RESPONSE" -eq 204 ]; then
            echo "✅ Dispatch PAT works for yii2-froala-editor-B"
          else
            echo "❌ Dispatch PAT failed for yii2-froala-editor-B"
            exit 1
          fi
